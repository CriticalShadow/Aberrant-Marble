<!DOCTYPE html>
<html ng-app='languageApp'>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- inject:css -->
  <link rel="stylesheet" href="./client/css/bower.css">
  <!-- endinject -->
  <script type='text/javascript' src='http://cdn.icecomm.io/icecomm.js'></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- inject:js -->
  <script src="./client/js/vendors.js"></script>
  <script src="./client/js/app.js"></script>
  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>

  <!-- endinject -->
</head>
<body ng-controller='selectLanguageController'>
  <div ui-view class="view"></div>
  <div id="videos">
    <div id='myVideo' class="inline">
      <video id='localVideo' autoplay></video>
    </div>
  </div>
  <div ng-include="'./client/footer.html'"></div>

  <script src="/bower_components/angular-ui-router/release/angular-ui-router.js"></script>
  <script src="/bower_components/angular-bootstrap/ui-bootstrap.js"></script>
  <script>
      var socket = io();
      var comm = new Icecomm('aOeyDUCGOSgnxElKI9eHiq9SRh2afLql1l1lDyxzYMYEabvTF6');

      socket.on('connected', function (data) {
        console.log(data);
      });

      socket.on('session', function (data) {
        window.sessionStorage.setItem('event.sid', data);
        document.cookie = 'event.sid=s%3A' + data;
      });
      
      socket.on('joinRoom', function (data) {
        console.log("JOining room", data);
        comm.connect(data);

        comm.on('local', function (options) {
          console.log(options.stream);
          $('#localVideo').attr("src", options.stream);
        });

        // When two people are connected, display the video of the language partner
        // and show the chat app
        comm.on('connected', function (options) {
          var foreignVidDiv = $('<div class="inline"></div>');
          foreignVidDiv.append(options.video)
          foreignVidDiv.children().addClass('foreignVideo');
          $('#videos').prepend(foreignVidDiv);
          // document.getElementById('videos').insertBefore(document.createElement("$BUTTON")options.video, document.getElementById('myVideo'));
          // $scope.$apply(function () { 
          //   $scope.showChatApp = true; 
          // });
        });
      });
      
      socket.on('connecting', function (data) {
        console.log("New room: ", data);

        comm.connect(data.room);
        socket.emit('roomRequest', data);

        // Show video of the user
        comm.on('local', function (options) {
          console.log(options.stream);
          $('#localVideo').attr("src", options.stream);
        });

        // When two people are connected, display the video of the language partner
        // and show the chat app
        comm.on('connected', function (options) {
          var foreignVidDiv = $('<div class="inline"></div>');
          foreignVidDiv.append(options.video)
          foreignVidDiv.children().addClass('foreignVideo');
          $('#videos').prepend(foreignVidDiv);
          // document.getElementById('videos').insertBefore(document.createElement("$BUTTON")options.video, document.getElementById('myVideo'));
          // $scope.$apply(function () { 
          //   $scope.showChatApp = true; 
          // });
        });

        // // When a chat message is received from the language partner,
        // // translate the message using Google Translate and
        // // display both the original message and the translated message
        // $scope.comm.on('data', function (options) {
        //   $scope.$apply(function(){
        //     Translate.translateMsg(options.data, $scope.language.native, $scope.language.desired)
        //     .then(function (translatedMsg) {
        //       console.log(translatedMsg);
        //       var translatedText = translatedMsg.data.translations[0].translatedText
        //       $scope.convo += 'Them: ' + options.data + '\n';
        //       $scope.convo += 'Them (translated): ' + translatedText + '\n';
        //       $scope.scrollBottom();
        //     })
        //   });
        // });

        // // When the language partner leaves, remove the video and chatbox
        // $scope.comm.on('disconnect', function (options) {
        //   document.getElementById(options.callerID).remove();
        //   $scope.$apply(function () {
        //     $scope.showChatApp = false;
        //   });
        // });
    });

    </script>
</body>
</html>
